@model LTW_QLBH_HUNMYI.Models.PHIEUNHAP
@{
    ViewBag.Title = "Tạo phiếu nhập";
    Layout = "~/Views/Shared/_LayoutOwner.cshtml";
}

<h2>Tạo phiếu nhập</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-row">
        <div class="form-group col-md-3">
            @Html.LabelFor(m => m.NGAYNHAP)
            @Html.TextBoxFor(m => m.NGAYNHAP, new { @class = "form-control", @Value = DateTime.Now.ToString("yyyy-MM-dd") })
        </div>
        <div class="form-group col-md-3">
            @Html.Label("Nhà cung cấp")
            <select name="MAXI" class="form-control">
                @foreach (var x in ViewBag.XuongIn)
                {
                    <option value="@x.MAXI">@x.TENXI</option>
                }
            </select>
        </div>
        <div class="form-group col-md-3">
            @Html.Label("Nhân viên")
            <input type="text" class="form-control" value="@Session["StaffName"]" readonly />
        </div>
    </div>

    <h4>Chọn sản phẩm</h4>
    <ul class="nav">
        @foreach (var dm in ViewBag.DanhMucList)
        {
            <li class="nav-item dropdown mr-3">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">@dm.TENDM</a>
                <div class="dropdown-menu p-2" style="max-height:200px; overflow-y:auto;">
                    @foreach (var sp in (ViewBag.Products as List<LTW_QLBH_HUNMYI.Models.SANPHAM>).Where(p => p.MADM == dm.MADM))
                    {
                        <a href="#" class="dropdown-item add-product"
                           data-id="@sp.MASP"
                           data-name="@sp.TENSP"
                           data-price="@sp.GIA"
                           data-category="@dm.TENDM">
                            @sp.TENSP - @sp.GIA VND
                        </a>
                    }
                </div>
            </li>
        }
    </ul>

    <h4 class="mt-3">Chi tiết phiếu nhập</h4>
    <table class="table table-bordered" id="importDetails">
        <thead>
            <tr>
                <th>Danh mục</th>
                <th>Sản phẩm</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-right"><strong>Tổng tiền:</strong></td>
                <td id="grandTotal">0</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <input type="submit" value="Lưu phiếu nhập" class="btn btn-primary" />
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            $(".add-product").click(function (e) {
                e.preventDefault();
                var id = $(this).data("id");
                var name = $(this).data("name");
                var price = $(this).data("price");
                var category = $(this).data("category");

                var row = `<tr>
                <td>${category}</td>
                <td>${name}<input type="hidden" name="productId" value="${id}"></td>
                <td><input type="number" name="qty" value="1" min="1" class="form-control qty"></td>
                <td>
                    ${price.toLocaleString()} 
                    <input type="hidden" name="price" value="${price}" class="form-control price">
                </td>
                <td class="total">${price}</td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">Xóa</button></td>
            </tr>`;
                $("#importDetails tbody").append(row);
                updateTotals();
            });

            $(document).on("click", ".remove-row", function () { $(this).closest("tr").remove(); updateTotals(); });
            $(document).on("change", ".qty, .price", function () { updateTotals(); });

            function updateTotals() {
                var grand = 0;
                $("#importDetails tbody tr").each(function () {
                    var qty = parseFloat($(this).find(".qty").val());
                    var price = parseFloat($(this).find(".price").val());
                    var total = qty * price;
                    $(this).find(".total").text(total);
                    grand += total;
                });
                $("#grandTotal").text(grand);
            }
        });
    </script>
}