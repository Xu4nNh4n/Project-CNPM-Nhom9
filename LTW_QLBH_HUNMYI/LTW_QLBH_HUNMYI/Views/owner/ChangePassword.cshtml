@{
    ViewBag.Title = "ChangePassword";
    Layout = "~/Views/Shared/_LayoutOwner.cshtml";
}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Owner")">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Profile", "Owner")">Tài khoản</a></li>
        <li class="breadcrumb-item active">Đổi mật khẩu</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <!-- Main Card -->
        <div class="card shadow-sm">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h4 class="mb-0">
                    <i class="fas fa-key"></i> Đổi mật khẩu
                </h4>
                <small>Cập nhật mật khẩu để bảo vệ tài khoản của bạn</small>
            </div>
            <div class="card-body p-4">
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <strong>Thành công!</strong> @TempData["Success"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Lỗi!</strong> @TempData["Error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <!-- Info Alert -->
                <div class="alert alert-info border-0 mb-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <strong>Yêu cầu mật khẩu:</strong>
                            <ul class="mb-0 mt-2 small">
                                <li>Tối thiểu 6 ký tự</li>
                                <li>Nên có chữ hoa, chữ thường và số</li>
                                <li>Không sử dụng thông tin cá nhân dễ đoán</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Change Password Form -->
                @using (Html.BeginForm("ChangePassword", "Owner", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate", id = "changePasswordForm" }))
                {
                    @Html.AntiForgeryToken()

                    <!-- Current Password -->
                    <div class="mb-4">
                        <label for="oldPassword" class="form-label fw-bold">
                            <i class="fas fa-lock text-muted"></i> Mật khẩu hiện tại <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-shield-alt text-primary"></i>
                            </span>
                            <input type="password" class="form-control form-control-lg" id="oldPassword" name="oldPassword"
                                   placeholder="Nhập mật khẩu hiện tại" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('oldPassword')">
                                <i class="fas fa-eye" id="oldPassword-icon"></i>
                            </button>
                            <div class="invalid-feedback">
                                Vui lòng nhập mật khẩu hiện tại
                            </div>
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="mb-4">
                        <label for="newPassword" class="form-label fw-bold">
                            <i class="fas fa-key text-muted"></i> Mật khẩu mới <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-lock text-success"></i>
                            </span>
                            <input type="password" class="form-control form-control-lg" id="newPassword" name="newPassword"
                                   placeholder="Nhập mật khẩu mới" minlength="6" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye" id="newPassword-icon"></i>
                            </button>
                            <div class="invalid-feedback">
                                Mật khẩu phải có ít nhất 6 ký tự
                            </div>
                        </div>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="mb-4" id="passwordStrength" style="display: none;">
                        <label class="form-label small text-muted">Độ mạnh mật khẩu:</label>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%; transition: all 0.3s;"></div>
                        </div>
                        <small id="strengthText" class="form-text d-block mt-1"></small>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label fw-bold">
                            <i class="fas fa-check-circle text-muted"></i> Xác nhận mật khẩu mới <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-lock text-warning"></i>
                            </span>
                            <input type="password" class="form-control form-control-lg" id="confirmPassword" name="confirmPassword"
                                   placeholder="Nhập lại mật khẩu mới" minlength="6" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye" id="confirmPassword-icon"></i>
                            </button>
                            <div class="invalid-feedback" id="passwordMatchError">
                                Mật khẩu xác nhận không khớp!
                            </div>
                        </div>
                        <div id="matchIndicator" class="mt-2" style="display: none;">
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> Mật khẩu khớp
                            </small>
                        </div>
                    </div>

                    <!-- Password Requirements Checklist -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body py-3">
                            <small class="text-muted fw-bold d-block mb-2">
                                <i class="fas fa-list-check"></i> Kiểm tra mật khẩu:
                            </small>
                            <div class="password-requirements">
                                <div id="req-length" class="requirement">
                                    <i class="fas fa-circle-xmark text-danger"></i>
                                    <small>Ít nhất 6 ký tự</small>
                                </div>
                                <div id="req-lowercase" class="requirement">
                                    <i class="fas fa-circle-xmark text-danger"></i>
                                    <small>Chứa chữ thường (a-z)</small>
                                </div>
                                <div id="req-uppercase" class="requirement">
                                    <i class="fas fa-circle-xmark text-danger"></i>
                                    <small>Chứa chữ hoa (A-Z)</small>
                                </div>
                                <div id="req-number" class="requirement">
                                    <i class="fas fa-circle-xmark text-danger"></i>
                                    <small>Chứa số (0-9)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-check"></i> Đổi mật khẩu
                        </button>
                        <a href="@Url.Action("Profile", "Owner")" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Hủy
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Security Tips -->
        <div class="card mt-4 border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0">
                    <i class="fas fa-shield-alt text-success"></i> Mẹo bảo mật tài khoản
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <strong>Đổi mật khẩu định kỳ</strong>
                                <br><small class="text-muted">3-6 tháng một lần</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <strong>Mật khẩu độc nhất</strong>
                                <br><small class="text-muted">Không dùng chung cho nhiều tài khoản</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <strong>Tránh thông tin cá nhân</strong>
                                <br><small class="text-muted">Không dùng tên, ngày sinh</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <strong>Đăng xuất an toàn</strong>
                                <br><small class="text-muted">Sau khi sử dụng máy công cộng</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
// Toggle password visibility
function togglePassword(fieldId) {
    var field = document.getElementById(fieldId);
    var icon = document.getElementById(fieldId + '-icon');

    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Password strength checker
$('#newPassword').on('input', function() {
    var password = $(this).val();
    var strength = 0;
    var strengthBar = $('#strengthBar');
    var strengthText = $('#strengthText');
    var container = $('#passwordStrength');

    if (password.length === 0) {
        container.hide();
        return;
    }

    container.show();

    // Calculate strength
    if (password.length >= 6) strength += 20;
    if (password.length >= 8) strength += 20;
    if (/[a-z]/.test(password)) strength += 20;
    if (/[A-Z]/.test(password)) strength += 20;
    if (/[0-9]/.test(password)) strength += 20;

    // Update progress bar
    strengthBar.css('width', strength + '%');
    strengthBar.removeClass('bg-danger bg-warning bg-info bg-success');

    if (strength <= 40) {
        strengthBar.addClass('bg-danger');
        strengthText.html('<i class="fas fa-times-circle"></i> Yếu').css('color', '#dc3545');
    } else if (strength <= 60) {
        strengthBar.addClass('bg-warning');
        strengthText.html('<i class="fas fa-exclamation-triangle"></i> Trung bình').css('color', '#ffc107');
    } else if (strength <= 80) {
        strengthBar.addClass('bg-info');
        strengthText.html('<i class="fas fa-check-circle"></i> Khá').css('color', '#17a2b8');
    } else {
        strengthBar.addClass('bg-success');
        strengthText.html('<i class="fas fa-shield-alt"></i> Mạnh').css('color', '#28a745');
    }

    // Update requirements checklist
    updateRequirements(password);
});

// Update password requirements
function updateRequirements(password) {
    // Length
    if (password.length >= 6) {
        $('#req-length i').removeClass('fa-circle-xmark text-danger').addClass('fa-circle-check text-success');
    } else {
        $('#req-length i').removeClass('fa-circle-check text-success').addClass('fa-circle-xmark text-danger');
    }

    // Lowercase
    if (/[a-z]/.test(password)) {
        $('#req-lowercase i').removeClass('fa-circle-xmark text-danger').addClass('fa-circle-check text-success');
    } else {
        $('#req-lowercase i').removeClass('fa-circle-check text-success').addClass('fa-circle-xmark text-danger');
    }

    // Uppercase
    if (/[A-Z]/.test(password)) {
        $('#req-uppercase i').removeClass('fa-circle-xmark text-danger').addClass('fa-circle-check text-success');
    } else {
        $('#req-uppercase i').removeClass('fa-circle-check text-success').addClass('fa-circle-xmark text-danger');
    }

    // Number
    if (/[0-9]/.test(password)) {
        $('#req-number i').removeClass('fa-circle-xmark text-danger').addClass('fa-circle-check text-success');
    } else {
        $('#req-number i').removeClass('fa-circle-check text-success').addClass('fa-circle-xmark text-danger');
    }
}

// Check password match
$('#confirmPassword').on('input', function() {
    var newPassword = $('#newPassword').val();
    var confirmPassword = $(this).val();

    if (confirmPassword.length === 0) {
        $('#matchIndicator').hide();
        $(this).removeClass('is-invalid is-valid');
        return;
    }

    if (newPassword === confirmPassword) {
        $(this).removeClass('is-invalid').addClass('is-valid');
        $('#matchIndicator').show();
        $('#passwordMatchError').hide();
    } else {
        $(this).removeClass('is-valid').addClass('is-invalid');
        $('#matchIndicator').hide();
        $('#passwordMatchError').show();
    }
});

// Form validation
$('#changePasswordForm').on('submit', function(e) {
    var form = this;
    var newPassword = $('#newPassword').val();
    var confirmPassword = $('#confirmPassword').val();

    // Check if passwords match
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        $('#confirmPassword').addClass('is-invalid');
        $('#passwordMatchError').show();
        showNotification('error', 'Mật khẩu xác nhận không khớp!');
        return false;
    }

    // Check minimum length
    if (newPassword.length < 6) {
        e.preventDefault();
        $('#newPassword').addClass('is-invalid');
        showNotification('error', 'Mật khẩu phải có ít nhất 6 ký tự!');
        return false;
    }

    if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        $(form).addClass('was-validated');
        showNotification('error', 'Vui lòng điền đầy đủ thông tin!');
        return false;
    }

    // Show loading
    var btn = $('#submitBtn');
    btn.prop('disabled', true);
    btn.html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

    return true;
});

// Remove error when user types
$('#confirmPassword').on('input', function() {
    $(this).removeClass('is-invalid');
    $('#passwordMatchError').hide();
});

$('#newPassword').on('input', function() {
    $(this).removeClass('is-invalid');
});

// Notification function
function showNotification(type, message) {
    var bgColor = type === 'success' ? '#28a745' :
                  type === 'error' ? '#dc3545' :
                  type === 'warning' ? '#ffc107' : '#17a2b8';
    var icon = type === 'success' ? 'fa-check-circle' :
               type === 'error' ? 'fa-times-circle' :
               type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';

    var notification = $('<div>')
        .addClass('alert alert-dismissible fade show')
        .css({
            'position': 'fixed',
            'top': '20px',
            'right': '20px',
            'z-index': '9999',
            'min-width': '300px',
            'background-color': bgColor,
            'color': 'white',
            'border': 'none',
            'box-shadow': '0 4px 12px rgba(0,0,0,0.15)',
            'animation': 'slideInRight 0.3s ease-out'
        })
        .html('<i class="fas ' + icon + '"></i> ' + message +
              '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>');

    $('body').append(notification);

    setTimeout(function() {
        notification.alert('close');
    }, 3000);
}

// Bootstrap form validation
(function() {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
    </script>

    <style>

        .requirement {
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

            .requirement i {
                margin-right: 8px;
                transition: all 0.3s ease;
            }

        .input-group-text {
            border-right: 0;
        }

        .input-group > .form-control {
            border-left: 0;
            border-right: 0;
        }

            .input-group > .form-control:focus {
                border-color: #ced4da;
                box-shadow: none;
            }

        .input-group:focus-within .input-group-text {
            border-color: #f093fb;
        }

        .input-group:focus-within > .form-control {
            border-color: #f093fb;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }

        .progress {
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            border-radius: 10px;
        }

        .card {
            border-radius: 15px;
            overflow: hidden;
        }

        .form-control-lg {
            font-size: 1rem;
        }
    </style>
}

